<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cart — InfinityCreations</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Cart page specific styles */
    .cart-wrap { max-width: 1100px; margin: 2rem auto; padding: 1rem; }
    .cart-grid { display: grid; grid-template-columns: 1fr 360px; gap: 1rem; align-items:start; }
    .card { background: var(--card); padding: 1rem; border-radius: 12px; box-shadow: var(--shadow-tight); }
    .cart-item { display:flex; gap:0.8rem; align-items:center; padding:0.6rem 0; border-bottom:1px solid rgba(0,0,0,0.06); }
    .cart-item img { width:92px; height:92px; object-fit:cover; border-radius:8px; }
    .item-meta { flex:1; }
    .item-title { font-weight:700; }
    .item-price { font-weight:800; color:var(--accent-2); }
    .qty-controls { display:flex; gap:0.4rem; align-items:center; margin-top:0.4rem; }
    .qty-controls button { padding:0.25rem 0.5rem; border-radius:6px; border:1px solid rgba(0,0,0,0.06); background:transparent; cursor:pointer; }
    .remove-btn { background:transparent;color:#b91c1c;border:none;cursor:pointer;padding:0.35rem 0.5rem;border-radius:6px }
    .summary-row { display:flex;justify-content:space-between;padding:0.5rem 0; }
    .empty { text-align:center;padding:2rem;color:var(--muted); }
    @media (max-width:980px) { .cart-grid { grid-template-columns: 1fr } }
  </style>
</head>
<body>
  <!-- shared header -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html" class="brand"><div class="logo">∞</div><div class="brand-text"><span class="brand-title">InfinityCreations</span><span class="brand-sub">Cart</span></div></a>
      <nav class="nav"><a href="index.html">Home</a><a href="products.html">Products</a><a href="about.html">About</a><a href="contact.html">Contact</a></nav>
      <div class="header-actions"><a href="checkout.html" class="btn ghost">Checkout</a> <button id="cart-count-btn" class="btn ghost">Cart (<span id="cart-count">0</span>)</button></div>
    </div>
  </header>

  <main class="container cart-wrap">
    <h1 style="margin-bottom:1rem">Your Cart</h1>

    <div class="cart-grid">
      <!-- left: items -->
      <section class="card" id="cart-items-wrap">
        <div id="cart-items"></div>
        <div id="cart-empty" class="empty" style="display:none">
          <h3>Your cart is empty</h3>
          <p class="muted">Add items from the <a href="products.html">Products</a> page.</p>
        </div>
      </section>

      <!-- right: summary -->
      <aside class="card">
        <div style="font-weight:800;margin-bottom:0.6rem">Order Summary</div>
        <div class="summary-row"><div>Items subtotal</div><div id="subtotal-val">₹0</div></div>
        <div class="summary-row"><div>Discount</div><div id="discount-val">-₹0</div></div>
        <div class="summary-row"><div>Delivery</div><div id="delivery-val">₹0</div></div>
        <div class="summary-row"><div>Tax (GST)</div><div id="tax-val">₹0</div></div>
        <hr>
        <div class="summary-row" style="font-weight:800;"><div>Total</div><div id="total-val">₹0</div></div>

        <div style="margin-top:0.8rem;display:flex;gap:0.6rem;flex-direction:column">
          <button id="proceed-checkout" class="btn primary">Proceed to Checkout</button>
          <button id="clear-cart" class="btn ghost">Clear Cart</button>
        </div>
      </aside>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-inner">
      <div>© InfinityCreations — handcrafted gifts</div>
      <div class="muted">Demo cart • localStorage</div>
    </div>
  </footer>

  <!-- include shared script (must be present) -->
  <script src="script.js"></script>

  <script>
    (function(){
      // keys must match script.js
      const LOCAL_CART_KEY = 'ic_cart';
      const DELIVERY_CHARGE = 49;
      const TAX_RATE = 0.18;

      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));

      function loadCartLocal() {
        try { return JSON.parse(localStorage.getItem(LOCAL_CART_KEY) || '[]') || []; }
        catch (e) { console.error('Failed to read cart', e); return []; }
      }
      function saveCartLocal(cart) {
        localStorage.setItem(LOCAL_CART_KEY, JSON.stringify(cart));
        if (window.IC && typeof window.IC.updateCartUI === 'function') window.IC.updateCartUI();
      }

      function formatPrice(v) { return '₹' + Number(v || 0).toFixed(0); }

      // render items list
      async function renderCart() {
        const wrap = $('#cart-items');
        const emptyBox = $('#cart-empty');
        wrap.innerHTML = '';

        const cart = loadCartLocal();
        if (!cart.length) {
          emptyBox.style.display = '';
          updateSummary();
          return;
        }
        emptyBox.style.display = 'none';

        // We want to display image/title/price; try to use product catalog if available
        let catalog = {};
        try {
          if (window.IC && typeof window.IC.getProducts === 'function') {
            const pList = window.IC.getProducts();
            // pList might be array or object; normalize to map
            if (Array.isArray(pList)) pList.forEach(p => { catalog[p.id] = p; });
            else Object.keys(pList || {}).forEach(k => { catalog[k] = pList[k]; });
          } else {
            const local = JSON.parse(localStorage.getItem('ic_products_local') || '[]') || [];
            local.forEach(p => catalog[p.id] = p);
          }
        } catch (e) {
          console.error('Catalog load failed', e);
        }

        cart.forEach(item => {
          const p = catalog[item.id] || {};
          const img = p.image || (p.images && p.images[0]) || (item.image || 'images/placeholder.png');
          const title = p.title || item.title || 'Product';
          const price = Number(item.price || p.price || 0);
          const qty = Number(item.qty || 1);

          const row = document.createElement('div');
          row.className = 'cart-item';
          row.innerHTML = `
            <img src="${img}" alt="${title}">
            <div class="item-meta">
              <div class="item-title">${title}</div>
              <div class="item-price">${formatPrice(price)}</div>
              <div class="qty-controls">
                <button class="qty-dec" data-id="${item.id}" aria-label="Decrease">−</button>
                <input class="qty-input" data-id="${item.id}" type="number" min="1" value="${qty}" style="width:64px;padding:0.3rem;border-radius:6px;border:1px solid rgba(0,0,0,0.06);text-align:center">
                <button class="qty-inc" data-id="${item.id}" aria-label="Increase">+</button>
                <button class="remove-btn" data-id="${item.id}">Remove</button>
              </div>
            </div>
            <div style="min-width:110px;text-align:right;font-weight:800">${formatPrice(price * qty)}</div>
          `;
          wrap.appendChild(row);
        });

        // bind qty events
        $$('.qty-inc').forEach(b => b.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          changeQty(id, 1);
        }));
        $$('.qty-dec').forEach(b => b.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          changeQty(id, -1);
        }));
        $$('.qty-input').forEach(inp => inp.addEventListener('change', (e) => {
          const id = e.currentTarget.dataset.id;
          const val = Math.max(1, Number(e.currentTarget.value || 1));
          setQty(id, val);
        }));
        $$('.remove-btn').forEach(b => b.addEventListener('click', (e) => {
          const id = e.currentTarget.dataset.id;
          removeItem(id);
        }));

        updateSummary();
      }

      function changeQty(id, delta) {
        const cart = loadCartLocal();
        const idx = cart.findIndex(i => String(i.id) === String(id));
        if (idx === -1) return;
        cart[idx].qty = Math.max(1, Number(cart[idx].qty || 1) + delta);
        saveCartLocal(cart);
        renderCart();
      }

      function setQty(id, qty) {
        const cart = loadCartLocal();
        const idx = cart.findIndex(i => String(i.id) === String(id));
        if (idx === -1) return;
        cart[idx].qty = Math.max(1, Number(qty || 1));
        saveCartLocal(cart);
        renderCart();
      }

      function removeItem(id) {
        let cart = loadCartLocal();
        cart = cart.filter(i => String(i.id) !== String(id));
        saveCartLocal(cart);
        renderCart();
      }

      function clearCart() {
        if (!confirm('Clear all items from cart?')) return;
        localStorage.removeItem(LOCAL_CART_KEY);
        if (window.IC && typeof window.IC.updateCartUI === 'function') window.IC.updateCartUI();
        renderCart();
      }

      // calculate summary and display
      function updateSummary() {
        const cart = loadCartLocal();
        const subtotal = cart.reduce((s,i) => s + (Number(i.price || 0) * Number(i.qty || 0)), 0);
        // If you used coupon/discount previously on checkout page that state wasn't persisted,
        // we show zero discount here (unless you persist coupon in localStorage and read it).
        const discount = 0;
        const delivery = subtotal >= 800 ? 0 : DELIVERY_CHARGE; // free shipping rule same as checkout
        const taxable = Math.max(0, subtotal - discount);
        const tax = Math.round(taxable * TAX_RATE);
        const total = Math.max(0, subtotal - discount + tax + delivery);

        $('#subtotal-val').textContent = formatPrice(subtotal);
        $('#discount-val').textContent = `- ${formatPrice(discount)}`;
        $('#delivery-val').textContent = formatPrice(delivery);
        $('#tax-val').textContent = formatPrice(tax);
        $('#total-val').textContent = formatPrice(total);

        // update header cart count
        if (window.IC && typeof window.IC.updateCartUI === 'function') window.IC.updateCartUI();
        else {
          // fallback: set #cart-count element if exists
          const countEl = document.getElementById('cart-count');
          if (countEl) {
            const qty = cart.reduce((s,i) => s + (Number(i.qty) || 0), 0);
            countEl.textContent = qty;
          }
        }

        // show/hide empty message
        const emptyBox = $('#cart-empty');
        const itemsWrap = $('#cart-items');
        if (!cart.length) {
          emptyBox.style.display = '';
          itemsWrap.style.display = 'none';
        } else {
          emptyBox.style.display = 'none';
          itemsWrap.style.display = '';
        }
      }

      // proceed to checkout
      function proceedToCheckout() {
        const cart = loadCartLocal();
        if (!cart.length) { alert('Your cart is empty'); return; }
        // go to checkout.html (checkout uses same localStorage key)
        location.href = 'checkout.html';
      }

      // wire buttons
      document.getElementById('proceed-checkout').addEventListener('click', proceedToCheckout);
      document.getElementById('clear-cart').addEventListener('click', clearCart);
      document.getElementById('cart-count-btn').addEventListener('click', () => location.href = 'checkout.html');

      // initial render
      renderCart();

      // keep summary updated if other tab changes cart
      window.addEventListener('storage', (e) => {
        if (e.key === LOCAL_CART_KEY) renderCart();
      });

    })();
  </script>
</body>
</html>
